{% extends "amherst_coursework_algo/base.html" %}
{% load static %}
{% block content %}
{% csrf_token %}
{{ DEPARTMENT_CODE_TO_NAME|json_script:"dept-dict" }}
<script src="{% static 'js/courses.js' %}"></script>

<div class = "page-container">
    <div id="side-panel" class="side-panel">
        <button class="close-panel" onclick="togglePanel()">×</button>
        <div id="panel-content">
        </div>
    </div>

    <div id="cart-side-panel" class="side-panel cart-panel">
        <h3>Saved Schedule</h3>
        <div id="cart-items"></div>
        <div id="cart-total">Total Courses: <span id="cart-count">0</span></div>
        <button class="close-panel" onclick="toggleCartPanel()">×</button>
    </div>

    <button id="cart-toggle" class="cart-toggle-button" onclick="toggleCartPanel()">
        View Saved Schedule (<span id="cart-count-header">0</span>)
    </button>

    <div class = "main-content">
        <div class="container">
            <h1>Amherst College Course Catalog</h1>

            <div class="search-container">
                <input type="text" 
                       id="searchInput"
                       placeholder="Search courses..."
                       class="search-input"
                       oninput="search_filter(this.value, 0.05)">
            </div>

            <div class="course-container">
                {% for course in courses %}
                <div class="course-card"
                        data-course-id="{{ course.id }}">
                        <div class="course-card-columns">
                            <div class="course-card-left">
                                <p class="course-code">
                                    {% for code in course.courseCodes.all %}
                                    <span class="course-code">{{ code.value }}</span>{% if not forloop.last %} {% endif %}
                                    {% endfor %}
                                </p>
                            </div>
                            <div class="course-card-right">
                                <div class="course-header">
                                    <div class="course-divisions">
                                        {% for div in course.divisions.all %}
                                            <span class="division-tag" course-division="{{ div.name }}">{{ div.name }}</span>
                                        {% endfor %}
                                    </div>
                                    <button class="cart-button" onclick="handleCartClick(event, '{{ course.id }}')" data-course-id="{{course.id}}">
                                        <i class="fa-solid fa-plus" style="color: #fff"></i>
                                    </button>
                                </div>
                                <h2 class="course-name">{{ course.courseName }}</h2>
                                <p class="course-description">{{ course.courseDescription }}</p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>

    /* Add this to your script section */
    function handleCartClick(event, courseId) {
        event.stopPropagation();  // Prevent event from bubbling up to course-card
        toggleCart(courseId);
    }

    function toggleCartPanel() {
        const panel = document.getElementById('cart-side-panel');
        panel.classList.toggle('open');
        updateCartDisplay();
    }

    function toggleCart(courseId) {
        // Get existing cart or initialize empty array
        let cart = JSON.parse(localStorage.getItem('courseCart') || '[]');
        
        // Check if course is already in cart
        let courseIndex = cart.indexOf(courseId)
        event = event || window.event;
        let button = event.target;
    
        if (courseIndex === -1) {
            cart.push(courseId);
            updateButtonState(courseId, true);
        } else {
            cart.splice(courseIndex, 1);
            updateButtonState(courseId, false);
        }
    
        // Save updated cart
        localStorage.setItem('courseCart', JSON.stringify(cart));
        updateCartDisplay();
    }

    function updateCartDisplay() {
    // 1. Get DOM elements
    const cartItems = document.getElementById('cart-items');
    const cartCount = document.getElementById('cart-count');
    const cartCountHeader = document.getElementById('cart-count-header');
    
    // 2. Get cart data from localStorage
    const cart = JSON.parse(localStorage.getItem('courseCart') || '[]');

    // 3. Clear existing content
    cartItems.innerHTML = '';

    if (cart.length === 0) {
        cartItems.innerHTML = '<p>Your saved schedule is empty</p>';
        cartCount.textContent = '0';
        cartCountHeader.textContent = '0';
        return;
    }
    
    // Fetch course details from server
    fetch(`/cart-courses/?${cart.map(id => `ids[]=${id}`).join('&')}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
    })
        .then(data => {
            cartItems.innerHTML = '';
            data.courses.forEach(course => {
                const courseElement = document.createElement('div');
                courseElement.className = 'cart-item';
                courseElement.innerHTML = `
                    <div class="cart-item-name">${course.name}</div>
                    <button class="remove-from-cart" 
                            onclick="toggleCart('${course.id}')">
                            X
                    </button>
                `;
                cartItems.appendChild(courseElement);
            });
            cartCount.textContent = cart.length;
            cartCountHeader.textContent = cart.length;
        });
    }

    function updateButtonState(courseId, inCart) {
        document.querySelectorAll(`.cart-button[data-course-id="${courseId}"]`).forEach(button => {
            const icon = button.querySelector('i');
            if (inCart) {
                icon.className = 'fa-solid fa-check';
                button.classList.add('in-cart');
            } else {
                icon.className = 'fa-solid fa-plus';
                button.classList.remove('in-cart');
            }
        });
    }

    function togglePanel(courseId = null) {
        const panel = document.getElementById('side-panel');
        const panelContent = document.getElementById('panel-content');
        const mainContent = document.querySelector('.main-content');
        const courseContainer = document.querySelector('.course-container');

        if (courseId) {
            const clickedCard = document.querySelector(`.course-card[data-course-id="${courseId}"]`);

            fetch(`/details/${courseId}/`)  
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to load course details: ${response.status}`);
                }
                return response.text();
            })
                .then(html => {
                    panelContent.innerHTML = html;
                    requestAnimationFrame(() => {
                        panel.classList.add('open');
                        mainContent.classList.add('shifted');
                        courseContainer.classList.add('shifted');

                        setTimeout(() => {
                            if (clickedCard) {
                                clickedCard.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'center'
                                });
                            }
                        }, 100);
                    });
                });
        } else {
            // Closing panel
            courseContainer.style.opacity = '0';
            courseContainer.classList.add('hidden');
            panel.classList.add('closing');

            document.querySelectorAll('.course-card').forEach(card => {
                card.classList.remove('active');
            });
            
            setTimeout(() => {
                panel.classList.remove('open');
                panel.classList.remove('closing');
                mainContent.classList.remove('shifted');
                courseContainer.classList.remove('shifted');
                
                // Fade content back in only after panel is closed and layout is adjusted
                setTimeout(() => {
                    courseContainer.classList.add('fade-in');
                    courseContainer.classList.remove('hidden');
                    courseContainer.style.opacity = '1';
                    
                    setTimeout(() => {
                        courseContainer.classList.remove('fade-in');
                    }, 300);
                }, 200);
            }, 600);
        }
    }

        // Initialize cart display when DOM content is loaded
    document.addEventListener('DOMContentLoaded', async function() {
        await initializeCourses();
        updateCartDisplay();

        document.querySelectorAll('.course-card').forEach(card => {
            card.addEventListener('click', function(event) {
                if (!event.target.closest('.cart-button')) {
                    // Remove active class from all cards
                    document.querySelectorAll('.course-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    // Add active class to clicked card
                    this.classList.add('active');
                    
                    const courseId = this.dataset.courseId;
                    togglePanel(courseId);
                }
            });
        });

        // Update button states to match cart
        const cart = JSON.parse(localStorage.getItem('courseCart') || '[]');
        document.querySelectorAll('.cart-button').forEach(button => {
            const courseId = button.getAttribute('onclick').match(/'([^']+)'/)[1];
            if (cart.includes(courseId)) {
                button.textContent = 'Remove from Saved Schedule';
                button.classList.add('in-cart');
            }
        });
    });
    </script>

</div>
{% endblock %}