{% extends "amherst_coursework_algo/base.html" %}
{% load static %}
{% block content %}
{% csrf_token %}
{{ DEPARTMENT_CODE_TO_NAME|json_script:"dept-dict" }}
<script src="{% static 'js/courses.js' %}"></script>

<div class = "page-container">

    <div id="side-panel" class="side-panel">
        <button class="close-panel" onclick="togglePanel()">×</button>
        <div id="panel-content">
        </div>
    </div>

    <div id="cart-side-panel" class="side-panel cart-panel">
        <h3>Saved Schedule</h3>
        <div id="cart-items"></div>
        <div id="cart-total">Total Courses: <span id="cart-count">0</span></div>
        <button class="close-panel" onclick="toggleCartPanel()">×</button>
    </div>

    <button id="cart-toggle" class="cart-toggle-button" onclick="toggleCartPanel()">
        View Saved Schedule (<span id="cart-count-header">0</span>)
    </button>

    <div class = "main-content">
        <div class="container">
            <h1>Amherst College Course Catalog</h1>

            <div class="search-container">
                <input type="text" 
                       id="searchInput"
                       placeholder="Search courses..."
                       class="search-input"
                       oninput="search_filter(this.value, 0.05)">
            </div>

            <div class="course-container">
                {% for course in courses %}
                <div class="course-card" 
                        data-course-id="{{ course.id }}">
                        <p style="margin-top: 0;">
                        {% for div in course.divisions.all %}
                            <span class="division-tag" course-division="{{ div.name }}">{{ div.name }}</span>{% if not forloop.last %} {% endif %}
                        {% endfor %}
                        </p>
                        <h2>{{ course.courseName }}</h2>
                        <p>Department: 
                            {% for dept in course.departments.all %}
                                {{ dept.name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <p> Code:
                            {% for code in course.courseCodes.all %}
                                {{ code.value }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <p> Keywords:
                            {% for keyword in course.keywords.all %}
                                {{ keyword.name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <div class="course-buttons">
                            <button class ="panel-button" onclick="togglePanel('{{ course.id }}')">Show Details</button>
                            <button class="cart-button" onclick="toggleCart('{{ course.id }}')"
                            data-course-id="{{course.id}}"> Add to Saved Schedule</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        await initializeCourses();
        updateCartDisplay();

        // Update button states to match cart
        const cart = JSON.parse(localStorage.getItem('courseCart') || '[]');
        document.querySelectorAll('.cart-button').forEach(button => {
            const courseId = button.getAttribute('onclick').match(/'([^']+)'/)[1];
            if (cart.includes(courseId)) {
                button.textContent = 'Remove from Saved Schedule';
                button.classList.add('in-cart');
            }
        });
    });
    </script>

</div>
{% endblock %}