{% extends "amherst_coursework_algo/base.html" %}
{% load static %}
{% load course_filters %}
{% block content %}
{% csrf_token %}
{{ DEPARTMENT_CODE_TO_NAME|json_script:"dept-dict" }}
<script src="{% static 'js/courses.js' %}"></script>

<div class = "page-container">
    <div id="side-panel" class="side-panel">
        <button class="close-panel" onclick="togglePanel()" title="Close course details panel" aria-label="Close course details panel">×</button>
        <div id="panel-content">
        </div>
    </div>

    <div id="cart-side-panel" class="side-panel cart-panel">
        <h3>Saved Schedule</h3>
        <div id="cart-courses-list"></div>
        <div id="cart-total">
            <div style="margin-bottom: 10px;">
                <strong>Total Credits:</strong> <span id="cart-credits">0</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="export-cart" title="Export your schedule to a file" aria-label="Export schedule">
                    <i class="fa-solid fa-download"></i> Workday Export
                </button>
                <button class="reset-cart" title="Clear all courses from your schedule" aria-label="Reset schedule">
                    <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
            </div>
        </div>
    
        <!-- Cart calendar -->
        <div class="cart-calendar-container">
            <!-- Headers -->
            <div class="corner-cell"></div>
            {% for day in "Monday,Tuesday,Wednesday,Thursday,Friday"|split:"," %}
                <div class="day-header">{{ day }}</div>
            {% endfor %}

            <!-- Time slots -->
            {% for hour in "7,8,9,10,11,12,13,14,15,16,17,18,19"|split:"," %}
                <div class="time-column">
                    {% with hour_val=hour|add:"0" %}
                        {% if hour_val < 12 %}
                            {{ hour_val }}:00 AM
                        {% elif hour_val == 12 %}
                            12:00 PM
                        {% else %}
                            {{ hour_val|add:"-12" }}:00 PM
                        {% endif %}
                    {% endwith %}
                </div>

                {% for prefix in "mon,tue,wed,thu,fri"|split:"," %}
                    <div class="time-slot" data-hour="{{ hour|add:'0' }}" data-day="{{ prefix }}">
                        <!-- Course blocks will be populated by JavaScript -->
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    
        <button class="close-panel" onclick="toggleCartPanel()" title="Close saved schedule panel" aria-label="Close saved schedule panel">×</button>
    </div>

    <button id="cart-toggle" class="cart-toggle-button" onclick="toggleCartPanel()" title="View your saved course schedule" aria-label="View saved schedule">
        View Saved Schedule (<span id="cart-count-header">0</span>)
    </button>

    <!-- AI Advisor Panel -->
    <div id="ai-advisor-panel" class="side-panel advisor-panel">
        <h3><i class="fa-solid fa-robot"></i> AI Course Advisor</h3>
        
        <div id="advisor-chat-container">
            <div id="advisor-messages"></div>
            
            <div class="advisor-input-container">
                <input type="text" 
                       id="advisor-question" 
                       placeholder="Ask me anything about your schedule..."
                       aria-label="Ask advisor a question"
                       onkeypress="if(event.key === 'Enter') askAdvisor()">
                <button onclick="askAdvisor()" class="advisor-send-btn" title="Send message">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
            
            <div class="advisor-quick-actions">
                <button onclick="askAdvisor('Analyze my schedule')">
                    <i class="fa-solid fa-chart-line"></i> Analyze Schedule
                </button>
                <button onclick="askAdvisor('Suggest courses for me')">
                    <i class="fa-solid fa-lightbulb"></i> Suggest Courses
                </button>
                <button onclick="askAdvisor('Check my prerequisites')">
                    <i class="fa-solid fa-list-check"></i> Check Prerequisites
                </button>
            </div>
        </div>
        
        <button class="close-panel" onclick="toggleAdvisorPanel()" title="Close AI advisor panel" aria-label="Close AI advisor panel">×</button>
    </div>

    <!-- AI Advisor Toggle Button -->
    <button id="ai-advisor-toggle" class="ai-advisor-button" 
            onclick="toggleAdvisorPanel()" 
            title="Get AI-powered course recommendations (Beta)"
            aria-label="Open AI advisor (Beta)">
        <i class="fa-solid fa-robot"></i> AI Advisor <span style="font-size: 0.75em; opacity: 0.8;">(Beta)</span>
    </button>

    <div class = "main-content">
        <div class="container">
            <div style="display: flex; align-items: flex-end; margin: 20px;">
                <h1>Amherst Course Catalog</h1>
                <a href="{% url 'catalog:about' %}" class="nav-link">About</a>
            </div>

            <div class="search-container">
                <form method="GET" action="{% url 'catalog:home' %}" class="search-container">
                    <input type="text" 
                        id="searchInput"
                        name="search"
                        placeholder="What are you curious about?"
                        class="search-input"
                        value="{{ search_query }}"
                        aria-label="Search for courses"
                        title="Enter what you want to search for. Our unified search supports course names, departments, professors, course codes, locations and general semantic understanding.">
                    <button type="submit" class="search-button" title="Search for courses" aria-label="Search">
                        <i class="fa-solid fa-search"></i> Search
                    </button>
                </form>
                <div id="search-loading" style="display: none;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Searching...
                </div>
            </div>

            <div id="conflict-loading" class="conflict-loading" style="display: none;">
                <i class="fa-solid fa-spinner fa-spin"></i> Checking for conflicts...
            </div>

            <div class="course-container">
                {% if not courses %}
                <p>No results found for "{{ search_query }}"</p>
                {% endif %}

                {% for course in courses %}
                <div class="course-card"
                    data-course-id="{{ course.id }}"
                    data-section-with-time="{{ course.section_with_time|default:'TBD' }}">
                    <div class="course-card-columns">
                        <div class="course-card-left">
                            <p class="course-code">
                                {% for code in course.courseCodes.all %}
                                <span class="course-code">{{ code.value }}</span>{% if not forloop.last %} {% endif %}
                                {% endfor %}
                            </p>
                        </div>
                        <div class="course-card-right">
                            <div class="course-header">
                                <button class="cart-button" 
                                    onclick="showSectionModal(event, '{{ course.id }}', '{{ course.courseName }}')" 
                                    data-course-id="{{course.id}}"
                                    title="Add course to schedule"
                                    aria-label="Add {{ course.courseName }} to schedule">
                                    <i class="fa-solid fa-plus" style="color: #fff"></i>
                                </button>
                            </div>
                            <h2 class="course-name">{{ course.courseName }}</h2>
                            <span class="info-text">Prof. {{ course.professor_name|default:"TBA" }} | {{ course.meeting_times|default:"TBD" }}</span>
                            <p class="course-description">{{ course.summary|default:course.courseDescription }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="pagination-controls" data-total-pages="{{ total_pages }}">
                <button id="prev-page" class="page-btn" {% if current_page == 1 %}disabled{% endif %} title="Go to previous page" aria-label="Previous page">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>
                <button id="next-page" class="page-btn" {% if current_page == total_pages %}disabled{% endif %} title="Go to next page" aria-label="Next page">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
        </div>
    </div>

    <div id="section-modal" class="modal" style="display: none;" role="dialog" aria-labelledby="modal-title" aria-modal="true">
        <div class="modal-content">
            <span class="close-modal" title="Close section selection" aria-label="Close modal">&times;</span>
            <h3 id="modal-title">Select Course Section</h3>
            <div id="section-list">
            </div>
        </div>
    </div>

    <script>
    // Rotating placeholder text for search input
    const placeholders = [
        "What are you curious about?",
        "Search by course, professor, or topic...",
        "Try 'learn to code' or 'climate change'...",
        "Find courses by building location...",
        "Search 'COSC-111' or 'Computer Science'...",
        "Explore courses by keyword or description...",
        "What do you want to learn this semester?",
        "Find your next favorite course..."
    ];
    
    let placeholderIndex = 0;
    let placeholderInterval = null;
    
    function rotatePlaceholder() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput && !searchInput.value && document.activeElement !== searchInput) {
            placeholderIndex = (placeholderIndex + 1) % placeholders.length;
            searchInput.placeholder = placeholders[placeholderIndex];
        }
    }
    
    function startPlaceholderRotation() {
        if (!placeholderInterval) {
            placeholderInterval = setInterval(rotatePlaceholder, 2000);
        }
    }
    
    function stopPlaceholderRotation() {
        if (placeholderInterval) {
            clearInterval(placeholderInterval);
            placeholderInterval = null;
        }
    }

    // Initialize cart display and set up event handlers when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', async function() {
        // Start rotating placeholders
        startPlaceholderRotation();
        
        // Stop rotation when user focuses on search input
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('focus', stopPlaceholderRotation);
        
        // Resume rotation when user leaves search input (if empty)
        searchInput.addEventListener('blur', function() {
            if (!this.value) {
                startPlaceholderRotation();
            }
        });
        // Update the cart display with current items
        updateCartDisplay();

        // Show loading indicator while checking for conflicts
        const loadingIndicator = document.getElementById('conflict-loading');
        loadingIndicator.style.display = 'block';

        // Check for time conflicts in cart and update UI accordingly
        try {
            await findAndMarkAllCartConflicts();
            bindCourseEvents();
        } catch (error) {
            console.error('Error in initialization:', error);
        } finally {
            loadingIndicator.style.display = 'none';
        }

        // Add click handlers to all course cards for panel toggling
        document.querySelectorAll('.course-card').forEach(card => {
            card.addEventListener('click', function(event) {
                // Only toggle panel if click wasn't on cart button
                if (!event.target.closest('.cart-button')) {
                    // Remove highlight from all other cards
                    document.querySelectorAll('.course-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    // Highlight the clicked card
                    this.classList.add('active');
                    
                    // Show course details in side panel
                    const courseId = this.dataset.courseId;
                    togglePanel(courseId);
                }
            });
        });

        // Add enter key handler for search input
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                // Prevent default form submission
                e.preventDefault();
                // Submit the form programmatically
                this.closest('form').submit();
            }
        });

        // Set up modal close button functionality
        const closeModalButton = document.querySelector('.close-modal');
        if (closeModalButton) {
            closeModalButton.addEventListener('click', function() {
                // Hide the section selection modal
                document.getElementById('section-modal').style.display = 'none';
            });
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('section-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Handle cart export functionality
        document.querySelector('.export-cart').addEventListener('click', async () => {
            try {
                await exportCart();
            } catch (error) {
                console.error('Error exporting cart:', error);
                alert('Failed to export schedule. Please try again.');
            }
        });

        // Handle cart reset functionality
        document.querySelector('.reset-cart').addEventListener('click', async () => {
            try {
                // Clear cart and remove styling
                await resetCart();
                // Recheck conflicts after cart is cleared
                await findAndMarkAllCartConflicts();
            } catch (error) {
                console.error('Error resetting cart:', error);
            }
        });

        // Initialize cart button states
        const cart = JSON.parse(localStorage.getItem('courseCart') || '[]');
        document.querySelectorAll('.cart-button').forEach(button => {
            const courseId = button.getAttribute('data-course-id');
            // Update button appearance based on cart status
            if (cart.some(item => item.courseId === courseId)) {
                updateButtonState(courseId, true);
            } else {
                updateButtonState(courseId, false);
            }
        });

        currentPage = {{ current_page }};

        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        
        prevBtn?.addEventListener('click', () => {
            if (currentPage > 1) {
                loadPage(currentPage - 1);
            }
        });
        
        nextBtn?.addEventListener('click', () => {
            const totalPages = parseInt(document.querySelector('.pagination-controls').dataset.totalPages);
            if (currentPage < totalPages) {
                loadPage(currentPage + 1);
            }
        });
    });
    </script>

</div>
{% endblock %}
